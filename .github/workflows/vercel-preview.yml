name: Vercel Preview Testing

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  preview-smoke-tests:
    name: Smoke Tests on Vercel Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for Vercel Preview Deployment
        id: vercel-deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentPollInterval = 10000; // 10 seconds
            const maxAttempts = 60; // 10 minutes max

            for (let i = 0; i < maxAttempts; i++) {
              const deployments = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request.head.ref,
                environment: 'Preview'
              });

              if (deployments.data.length > 0) {
                const latestDeployment = deployments.data[0];
                const statuses = await github.rest.repos.listDeploymentStatuses({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: latestDeployment.id
                });

                const successStatus = statuses.data.find(s => s.state === 'success');
                if (successStatus && successStatus.target_url) {
                  console.log(`Deployment ready: ${successStatus.target_url}`);
                  core.setOutput('url', successStatus.target_url);
                  return successStatus.target_url;
                }
              }

              console.log(`Waiting for deployment... (attempt ${i + 1}/${maxAttempts})`);
              await new Promise(resolve => setTimeout(resolve, deploymentPollInterval));
            }

            throw new Error('Deployment did not complete in time');

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests on preview
        run: npx playwright test --grep @smoke --project=chromium
        env:
          PLAYWRIGHT_TEST_BASE_URL: ${{ steps.vercel-deployment.outputs.url }}
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preview-smoke-test-results
          path: playwright-report/
          retention-days: 7

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '‚úÖ' : '‚ùå';
            const url = '${{ steps.vercel-deployment.outputs.url }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Vercel Preview Deployment\n\n${status} Smoke tests **${{ job.status }}**\n\nüîó Preview URL: ${url}`
            });

  lighthouse:
    name: Lighthouse Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Vercel Preview
        id: vercel-url
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentPollInterval = 10000;
            const maxAttempts = 60;

            for (let i = 0; i < maxAttempts; i++) {
              const deployments = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request.head.ref,
                environment: 'Preview'
              });

              if (deployments.data.length > 0) {
                const latestDeployment = deployments.data[0];
                const statuses = await github.rest.repos.listDeploymentStatuses({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: latestDeployment.id
                });

                const successStatus = statuses.data.find(s => s.state === 'success');
                if (successStatus && successStatus.target_url) {
                  core.setOutput('url', successStatus.target_url);
                  return successStatus.target_url;
                }
              }

              await new Promise(resolve => setTimeout(resolve, deploymentPollInterval));
            }

            throw new Error('Deployment did not complete in time');

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            ${{ steps.vercel-url.outputs.url }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3

      - name: Comment Lighthouse results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let lighthouseResults = '';

            try {
              // Lighthouse CI saves results to .lighthouseci/
              const files = fs.readdirSync('.lighthouseci');
              const manifestPath = `.lighthouseci/${files.find(f => f.includes('manifest'))}`;
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));

              const scores = manifest[0].summary;
              lighthouseResults = `
              ## üèÜ Lighthouse Scores

              - ‚ö° Performance: ${Math.round(scores.performance * 100)}
              - ‚ôø Accessibility: ${Math.round(scores.accessibility * 100)}
              - ‚úÖ Best Practices: ${Math.round(scores['best-practices'] * 100)}
              - üîç SEO: ${Math.round(scores.seo * 100)}

              [View Full Report](${manifest[0].url})
              `;
            } catch (error) {
              lighthouseResults = '‚ö†Ô∏è Could not parse Lighthouse results';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: lighthouseResults
            });
